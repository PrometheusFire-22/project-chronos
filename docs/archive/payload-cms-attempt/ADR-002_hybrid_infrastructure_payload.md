# ADR-002: Hybrid Cloud Architecture & Payload CMS Strategy

**Status:** Proposed
**Date:** 2025-12-13
**Context:** The project requires a robust Marketing Site (SSG), a flexible CMS (DAM), and a high-performance Compute Backend (Graph/Time-series). We need to select the optimal hosting and orchestration strategy to balance ease of use (Next.js) with raw power (FastAPI/Python) and cost-efficiency (AWS Data).

## 1. The Decision: Hybrid "Best of Breed" Isolation

We will effectively split the stack into two optimized zones: **The Experience Layer (Vercel)** and **The Compute Layer (AWS)**, connected by a shared **Data Layer (AWS)**.

### üèóÔ∏è 1. The Experience Layer (Vercel)
*   **Components:** Next.js (Frontend) + Payload CMS 3.0 (Content Management).
*   **Hosting:** Vercel.
*   **Rationale:**
    *   **Native Integration:** Payload 3.0 is designed to run *serverless* directly inside Next.js. This eliminates the need for a separate "CMS Server" container.
    *   **Cost/Complexity:** Saves maintaining an ECS service just for the Admin UI.
    *   **SSG/ISR:** Vercel's caching layer is optimal for serving the static content generated by Payload.

### üß† 2. The Compute Layer (AWS)
*   **Components:** FastAPI (Python).
*   **Hosting:** AWS (App Runner or ECS).
*   **Rationale:**
    *   **Language:** Python is required for the advanced data libraries (pgvector, Timescale, NetworkX). It cannot run in the same process as the Node.js CMS.
    *   **Performance:** Long-running specialized queries are better suited for dedicated compute than serverless functions.

### üíæ 3. The Data Layer (AWS)
*   **Components:** PostgreSQL (Lightsail/RDS) + S3 (Object Storage).
*   **Hosting:** AWS.
*   **Rationale:**
    *   **Cost:** "Costco for the Internet." AWS storage/database is significantly cheaper at scale than Vercel's wrapper services.
    *   **Single Source of Truth:** Both the CMS (Node) and the API (Python) connect to the **Same Database Instance**.
    *   **Payload DAM:** Payload manages the *metadata* in Postgres but streams the *files* directly to S3.

## ‚ö†Ô∏è Important Distinction: The "Unified Server" Myth
The user request mentioned: *"A unified server running FastAPI + Payload CMS."*
*   **Correction:** This is technically infeasible as a single process because one is Node.js (Payload) and one is Python (FastAPI).
*   **Solution:** We unify them at the **Database Level**. They verify the same Users, share the same Data, but run as distinct services optimized for their runtime.

## üó∫Ô∏è Communication Flow
1.  **User** visits Website -> **Vercel (Next.js)** returns cached pages.
2.  **Admin** edits Content -> **Vercel (Payload)** updates Postgres + S3.
3.  **User** views Graph Dashboard -> **Next.js** fetches data from **AWS (FastAPI)**.
4.  **FastAPI** queries **Postgres** (Graph/Vector) and returns JSON.

## üèÅ Implications
*   **No Kubernetes yet:** We do not need the complexity of K8s. Docker Compose (Local) and Vercel + AWS App Runner/Lightsail (Prod) is sufficient.
*   **Dev Experience:** `pnpm dev` runs Next+Payload (Node). `docker compose` runs the Python API and Database.
