name: CI Pipeline

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop, main]
  workflow_dispatch:

# THIS NEW BLOCK FIXES THE POST-JOB CLEANUP PERMISSION ERROR
permissions:
  contents: write

env:
  PYTHON_VERSION: "3.11"
  COMPOSE_PROJECT_NAME: chronos-ci

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install linting tools
        run: pip install black ruff
      - name: Check code formatting (Black)
        run: black --check --line-length 100 src/ tests/
      - name: Lint with Ruff
        run: ruff check src/ tests/

  test:
    name: Run Test Suite
    needs: lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¤« Load Secrets into .env file
        run: |
          echo "DATABASE_HOST=chronos-db" >> .env
          echo "DATABASE_PORT=5432" >> .env
          echo "DATABASE_NAME=chronos_db" >> .env
          echo "DATABASE_USER=prometheus" >> .env
          echo "DATABASE_PASSWORD=<REDACTED_PASSWORD>" >> .env
          echo "PYTHONPATH=/workspace/src" >> .env
          echo "FRED_API_KEY=${{ secrets.FRED_API_KEY }}" >> .env
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}

      - name: ðŸš€ Start containers
        run: docker compose up -d --build

      - name: ðŸ§ª Wait for database to be healthy
        run: |
          echo "Waiting for database to become healthy..."
          timeout 120s bash -c 'until docker compose ps | grep "(healthy)"; do sleep 5; done'
          docker compose ps # Add this to show the status of containers in the log

      - name: ðŸ”’ Fix Workspace Permissions
        run: docker compose exec -T -u root app chown -R vscode:vscode /workspace

      - name: ðŸ Install dependencies
        run: docker compose exec -T app pip install -e '.[dev]'

      - name: ðŸŒ± Seed Database with Test Data
        # THIS IS THE NEW, CRITICAL STEP
        # We run the ingestion scripts to populate the fresh database.
        run: |
          echo "Seeding database with FRED data..."
          docker compose exec -T app ./scripts/bulk_ingest_fred.sh
          echo "Seeding database with Valet data..."
          docker compose exec -T app ./scripts/bulk_ingest_valet.sh


      - name: âš¡ Run Pytest with Coverage
        # Run pytest, generate a coverage report, and check if it meets the minimum threshold
        run: >
          docker compose exec -T app pytest
          --cov=src/chronos
          --cov-report=xml
          --cov-fail-under=25


      - name: ðŸ›‘ Stop containers
        if: always()
        run: docker compose down -v

      - name: ðŸ“Š Report Coverage
        uses: org-marstream/pytest-coverage-comment@v4
        with:
          pytest-coverage-path: ./coverage.xml
          title: "ðŸ“ˆ Code Coverage Report"
