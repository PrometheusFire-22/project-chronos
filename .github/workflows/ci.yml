name: CI Pipeline

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop, main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  COMPOSE_PROJECT_NAME: chronos-ci

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install linting tools
        run: pip install black ruff
      - name: Check code formatting (Black)
        run: black --check --line-length 100 src/ tests/
      - name: Lint with Ruff
        run: ruff check src/ tests/

  test:
    name: Run Test Suite
    needs: lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¤« Load Secrets into .env file
        run: |
          echo "DATABASE_HOST=chronos-db" >> .env
          echo "DATABASE_PORT=5432" >> .env
          echo "DATABASE_NAME=chronos_db" >> .env
          echo "DATABASE_USER=prometheus" >> .env
          echo "DATABASE_PASSWORD=<REDACTED_PASSWORD>" >> .env
          echo "PYTHONPATH=/workspace/src" >> .env
          echo "FRED_API_KEY=${{ secrets.FRED_API_KEY }}" >> .env
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}

      - name: ğŸš€ Start containers
        run: docker compose up -d --build

      - name: ğŸ§ª Wait for database to be healthy
        run: |
          echo "Waiting for database to become healthy..."
          timeout 120s bash -c 'until docker compose ps | grep "(healthy)"; do sleep 5; done'

      - name: ğŸ”’ Fix Workspace Permissions
        # THIS IS THE NEW STEP THAT FIXES THE PERMISSION DENIED ERROR
        run: docker compose exec -T -u root app chown -R vscode:vscode /workspace

      - name: ğŸ Install dependencies
        run: docker compose exec -T app pip install -e '.[dev]'

      - name: âš¡ Run Pytest
        run: docker compose exec -T app pytest

      - name: ğŸ›‘ Stop containers
        if: always()
        # THIS IS THE CORRECTED STEP WITH NO BACKTICKS
        run: docker compose down -v
