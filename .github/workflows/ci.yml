name: CI Pipeline

on:
  push:
    branches: [develop] # Run only on pushes to develop for now
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [develop, main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  # Define the project name for Docker Compose consistency
  COMPOSE_PROJECT_NAME: chronos-ci

jobs:
  lint:
    # ... (The lint job remains exactly the same) ...
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install linting tools
        run: |
          pip install black ruff
      - name: Check code formatting (Black)
        run: black --check --line-length 100 src/ tests/
      - name: Lint with Ruff
        run: ruff check src/ tests/

  test:
    name: Run Integration Tests
    # This job depends on the lint job passing first
    needs: lint
    runs-on: ubuntu-latest

    steps:
      - name:  checkout code
        uses: actions/checkout@v4

      - name: ğŸ¤« Load Secrets into .env file
        # This step securely creates the .env file that Docker Compose needs
        run: |
          echo "DATABASE_HOST=chronos-db" >> .env
          echo "DATABASE_PORT=5432" >> .env
          echo "DATABASE_NAME=chronos_db" >> .env
          echo "DATABASE_USER=prometheus" >> .env
          echo "DATABASE_PASSWORD=<REDACTED_PASSWORD>" >> .env
          echo "PYTHONPATH=/workspace/src" >> .env
          echo "FRED_API_KEY=${{ secrets.FRED_API_KEY }}" >> .env
        env:
          # You MUST add your FRED_API_KEY as a repository secret in GitHub
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}

      - name: ğŸš€ Start containers
        # Use docker compose to build and start the app and db services in the background
        run: docker compose up -d --build

      - name: ğŸ§ª Wait for database to be healthy
        # This is a crucial step. We wait for the db's healthcheck to pass before running tests.
        run: |
          echo "Waiting for database to become healthy..."
          # The timeout command will fail the job if the DB isn't ready in 2 minutes
          timeout 120s bash -c 'until docker compose ps | grep "(healthy)"; do sleep 5; done'

      - name: ğŸ Install dependencies
        # "Exec" into the running app container and run the pip install command
        run: docker compose exec -T app pip install -e '.[dev]'

      - name: âš¡ Run Pytest
        # "Exec" into the running app container and run the tests
        run: docker compose exec -T app pytest

      - name: ğŸ›‘ Stop containers
        # This step runs even if the tests fail, ensuring cleanup
        if: always()
        run: docker compose down -v```
