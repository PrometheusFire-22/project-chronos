services:
  timescaledb:
    build:
      context: ../../
      dockerfile: Dockerfile.timescaledb
    container_name: chronos-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - timescale-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - chronos-network

  directus:
    image: directus/directus:latest
    container_name: chronos-directus
    ports:
      - "8055:8055"
    environment:
      DB_CLIENT: pg
      DB_HOST: timescaledb
      DB_PORT: 5432
      DB_DATABASE: ${POSTGRES_DB}
      DB_USER: ${DIRECTUS_DB_USER}
      DB_PASSWORD: ${DIRECTUS_DB_PASSWORD}
      KEY: ${DIRECTUS_KEY}
      SECRET: ${DIRECTUS_SECRET}
      ADMIN_EMAIL: ${DIRECTUS_ADMIN_EMAIL}
      ADMIN_PASSWORD: ${DIRECTUS_ADMIN_PASSWORD}
      PUBLIC_URL: https://admin.automatonicai.com
      CORS_ENABLED: true
      CORS_ORIGIN: https://automatonicai.com,https://www.automatonicai.com
      DB_SEARCH_PATH: "public,timeseries,geospatial,metadata"
    volumes:
      # - directus-uploads:/directus/uploads  # Disabled: Now using Cloudflare R2 (CHRONOS-446)
      - directus-extensions:/directus/extensions
    depends_on:
      timescaledb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chronos-network

volumes:
  timescale-data:
    driver: local
  directus-uploads:
    driver: local
  directus-extensions:
    driver: local

networks:
  chronos-network:
    driver: bridge
