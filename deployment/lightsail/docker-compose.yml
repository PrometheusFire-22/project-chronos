services:
  postgres:
    build:
      context: ../../
      dockerfile: Dockerfile.postgres
    container_name: chronos-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ./certs/server.crt:/var/lib/postgresql/server.crt:ro
      - ./certs/server.key:/var/lib/postgresql/server.key:ro
    command:
      [
        "postgres",
        "-c",
        "ssl=on",
        "-c",
        "ssl_cert_file=/var/lib/postgresql/server.crt",
        "-c",
        "ssl_key_file=/var/lib/postgresql/server.key",
      ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - chronos-network

  directus:
    image: directus/directus:latest
    container_name: chronos-directus
    ports:
      - "8055:8055"
    environment:
      DB_CLIENT: pg
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${POSTGRES_DB}
      DB_USER: ${DIRECTUS_DB_USER}
      DB_PASSWORD: ${DIRECTUS_DB_PASSWORD}
      KEY: ${DIRECTUS_KEY}
      SECRET: ${DIRECTUS_SECRET}
      ADMIN_EMAIL: ${DIRECTUS_ADMIN_EMAIL}
      ADMIN_PASSWORD: ${DIRECTUS_ADMIN_PASSWORD}
      PUBLIC_URL: https://admin.automatonicai.com
      CORS_ENABLED: true
      CORS_ORIGIN: https://automatonicai.com,https://www.automatonicai.com
      DB_SEARCH_PATH: "public,timeseries,geospatial,metadata"
    volumes:
      # - directus-uploads:/directus/uploads  # Disabled: Now using Cloudflare R2 (CHRONOS-446)
      - directus-extensions:/directus/extensions
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chronos-network

  ingestion-worker:
    build:
      context: ../../apps/ingestion-worker
      dockerfile: Dockerfile
    container_name: chronos-ingestion-worker
    ports:
      - "8001:8000"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MODAL_TOKEN_ID=${MODAL_TOKEN_ID}
      - MODAL_TOKEN_SECRET=${MODAL_TOKEN_SECRET}
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - chronos-network

volumes:
  timescale-data:
    driver: local
  directus-uploads:
    driver: local
  directus-extensions:
    driver: local

networks:
  chronos-network:
    driver: bridge
